name: Deploy Preflight

on:
  workflow_dispatch:

jobs:
  preflight:
    runs-on: ubuntu-latest
    env:
      AWS_REGION: ${{ vars.AWS_REGION }}
      AWS_ACCOUNT_ID: ${{ vars.AWS_ACCOUNT_ID }}
      S3_BUCKET: ${{ vars.S3_BUCKET }}
      S3_PREFIX: ${{ vars.S3_PREFIX }}
      ECS_CLUSTER: ${{ vars.ECS_CLUSTER }}
      SUBNET_IDS: ${{ vars.SUBNET_IDS }}
      SECURITY_GROUP_ID: ${{ vars.SECURITY_GROUP_ID }}
      ALERT_EMAIL: ${{ vars.ALERT_EMAIL }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate required vars and secrets shape
        run: |
          set -euo pipefail

          fail() {
            echo "[ERROR] $1" >&2
            exit 1
          }

          [ -n "${AWS_REGION:-}" ] || fail "Missing vars.AWS_REGION"
          [ -n "${S3_BUCKET:-}" ] || fail "Missing vars.S3_BUCKET"
          [ -n "${ECS_CLUSTER:-}" ] || fail "Missing vars.ECS_CLUSTER"
          [ -n "${SUBNET_IDS:-}" ] || fail "Missing vars.SUBNET_IDS"
          [ -n "${SECURITY_GROUP_ID:-}" ] || fail "Missing vars.SECURITY_GROUP_ID"
          [ -n "${AWS_ACCESS_KEY_ID:-}" ] || fail "Missing secrets.AWS_ACCESS_KEY_ID"
          [ -n "${AWS_SECRET_ACCESS_KEY:-}" ] || fail "Missing secrets.AWS_SECRET_ACCESS_KEY"

          [[ "$AWS_REGION" =~ ^[a-z]{2}-[a-z]+-[0-9]$ ]] || fail "AWS_REGION has invalid format"
          [[ "$S3_BUCKET" =~ ^[a-z0-9][a-z0-9.-]{1,61}[a-z0-9]$ ]] || fail "S3_BUCKET has invalid format"
          [[ "$ECS_CLUSTER" =~ ^[a-zA-Z0-9_-]{1,255}$ ]] || fail "ECS_CLUSTER has invalid format"
          [[ "$SECURITY_GROUP_ID" =~ ^sg-[0-9a-f]+$ ]] || fail "SECURITY_GROUP_ID has invalid format"
          [[ "$SUBNET_IDS" =~ ^subnet-[0-9a-f]+(,subnet-[0-9a-f]+)*$ ]] || fail "SUBNET_IDS must be comma-separated subnet IDs"

          if [ -n "${AWS_ACCOUNT_ID:-}" ]; then
            [[ "$AWS_ACCOUNT_ID" =~ ^[0-9]{12}$ ]] || fail "AWS_ACCOUNT_ID must be 12 digits"
          fi

          if [ -n "${S3_PREFIX:-}" ]; then
            [[ "$S3_PREFIX" != /* ]] || fail "S3_PREFIX must be relative (no leading slash)"
          fi

          if [ -n "${ALERT_EMAIL:-}" ]; then
            [[ "$ALERT_EMAIL" =~ ^[^@[:space:]]+@[^@[:space:]]+\.[^@[:space:]]+$ ]] || fail "ALERT_EMAIL has invalid format"
          fi

          [[ "$AWS_ACCESS_KEY_ID" =~ ^(AKIA|ASIA)[A-Z0-9]{16}$ ]] || fail "AWS_ACCESS_KEY_ID has invalid format"
          [ "${#AWS_SECRET_ACCESS_KEY}" -ge 30 ] || fail "AWS_SECRET_ACCESS_KEY appears invalid"

      - name: Shell syntax checks
        run: |
          for script in twitchiobot/infrastructure/aws/*.sh; do
            bash -n "$script"
          done

      - name: JSON parse checks
        run: |
          python - <<'PY'
          import glob
          import json

          for path in sorted(glob.glob("twitchiobot/infrastructure/aws/*.json")):
              with open(path, "r", encoding="utf-8") as file_handle:
                  json.load(file_handle)
              print(f"OK: {path}")
          PY
